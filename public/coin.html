
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Wallet Page</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="./css/style.css">
  <link rel="stylesheet" href="./css/aos.css">
  <!-- Google Fonts: Montserrat -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000&display=swap" rel="stylesheet">

  <style>
    .crypto-card {
      text-align: center;
      transition: 0.3s;
      background-color: #0D121C;
      border-radius: 12px;
      padding: 20px;
      /* margin-bottom: 30px; */
      transition: 0.3s ease;
      /* height: 100%; */
      border: 1px solid rgb(68, 68, 68);
    }
    .crypto-logo {
      width: 40px;
      height: 40px;
      margin-bottom: 10px;
    }
    .wallet-logo {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }
    .wallet-address {
      font-family: monospace;
      background: #eee;
      padding: 10px;
      margin: 1rem 0;
      border-radius: 5px;
    }
    button {
      margin: 0.5rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
    }
    #qrCode {
      margin-top: 0.2rem;
    }
    .wallet-address-container {
  max-width: 100%;
  overflow-x: auto;
  white-space: nowrap;
  padding: 8px 12px;
  border: 1px solid #0d0d0d;
  border-radius: 5px;
  background-color: #f9f9f9;

  /* Optional: scrollbar styling */
  scrollbar-width: thin;
  scrollbar-color: rgb(47, 56, 56) #0D121C;
}

/* For Webkit browsers (Chrome, Safari) */
.wallet-address-container::-webkit-scrollbar {
  height: 6px;
}
.wallet-address-container::-webkit-scrollbar-track {
  background: #0D121C;
}
.wallet-address-container::-webkit-scrollbar-thumb {
  background-color: #0D121C;
  border-radius: 10px;
}
  </style>
</head>
<body>
  <form action="">
    <div class="crypto-card col-md-6 col-11 mt-5 mx-auto">
        <span id="coinName" class="fs-3 me-1">Loading...</span> <span class="bg-dark px-2" id="coinCurrency"></span><br>
        <img id="coinLogo" class="wallet-logo mt-3" src="" alt="Logo" />
        <input id="amountInput" type="number" class="col-md-12 p-2 rounded form-control bg-light mt-5 mb-3" placeholder="Enter amount you sent" required>
        <small class="text-danger text-left" id="error"></small>
        <div id="walletAddress" class="wallet-address wallet-address-container bg-dark col-12 overflow-x-scroll">
          <p>Loading address...</p>
        </div>
        <div class="mt-0 mb-3">
          <button onclick="copyAddress()" class="btn bg-dark text-white"><span class="bi bi-copy"></span></button>
          <button onclick="shareAddress()" class="btn bg-dark text-white"><span class="bi bi-share-fill"></span></button>
        </div>
        <span class="mt-4 fw-semibold">Scan the code below</span><br>
        <img id="qrCode" alt="QR Code Loading..." width="150" />
        <button 
          id="paymentBtn" 
          type="button" 
          class="btn primary-btn w-100 mt-4" 
          onclick="handlePaymentClick()">
          <span id="paymentBtnText">I have made payment</span>
          <span id="paymentBtnLoader" class="spinner-border spinner-border-sm ms-2 d-none"></span>
        </button>

  </form>

  <!-- Success Modal -->
  <div class="modal fade bg-dark" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4 py-5">
        <div class="checkmark-wrapper">
          <svg viewBox="0 0 52 52">
            <circle class="circle" cx="26" cy="26" r="24" />
            <path class="checkmark" d="M14 27 L22 35 L38 18" />
          </svg>
        </div>
        <h4 class="text-success">Successful</h4>
        <p class="text-dark">We will confirm your transaction shortly.</p>
        <a href="./transact.html"><button type="button" class="btn w-100 bg-dark text-white mt-3" data-bs-dismiss="modal">Close</button></a>
      </div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    window.onload = () => {
      const coinData = JSON.parse(localStorage.getItem("selectedCoin"));
      if (!coinData) {
        alert("No coin data found.");
        return;
      }

      const { name, logo, address, currency } = coinData;

      document.getElementById("coinName").textContent = name;
      document.getElementById("walletAddress").textContent = address;
      document.getElementById("coinLogo").src = logo;
      document.getElementById("coinCurrency").textContent = currency;

      // âœ… Generate QR code using the address
      const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(address)}&size=150x150`;
      document.getElementById("qrCode").src = qrUrl;
    };

    function copyAddress() {
      const address = document.getElementById("walletAddress").textContent;
      navigator.clipboard.writeText(address).then(() => alert("Address copied!"));
    }

    function shareAddress() {
      const address = document.getElementById("walletAddress").textContent;
      if (navigator.share) {
        navigator.share({ title: "Wallet Address", text: address });
      } else {
        alert("Sharing not supported on this device.");
      }
    }
  </script>
  
  <script>
function handlePaymentClick() {
  const amountInput = document.getElementById('amountInput');
  const amountValue = amountInput ? amountInput.value.trim() : '';
  const errorEl = document.getElementById('error');
  const paymentBtn = document.getElementById('paymentBtn');
  const btnText = document.getElementById('paymentBtnText');
  const btnLoader = document.getElementById('paymentBtnLoader');

  // Show loading
  btnText.textContent = "Processing...";
  btnLoader.classList.remove("d-none");
  paymentBtn.disabled = true;

  if (!amountValue) {
    if (errorEl) errorEl.textContent = 'Please enter an amount before proceeding.';
    resetButton();
    return;
  }

  const walletAddressEl = document.getElementById('walletAddress');
  const address = walletAddressEl ? walletAddressEl.textContent.trim() : '';
  if (!address) {
    alert('Wallet address not available.');
    resetButton();
    return;
  }

  const token = localStorage.getItem('authToken');
  if (!token) {
    alert('You must be logged in to add a wallet.');
    resetButton();
    return;
  }

  const coinName = document.getElementById('coinName') ? document.getElementById('coinName').textContent : '';
  const payload = {
    amount: amountValue,       // ðŸ”¹ amount comes from input
    currency: coinName           // ðŸ”¹ optional if your Deposit model tracks coin
  };

  fetch('https://qfstrade.pythonanywhere.com/deposit/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Token ' + token
    },
    body: JSON.stringify(payload)
  })
    .then(res => res.json())
    .then(result => {
      if (result && !result.error) {
        const modal = new bootstrap.Modal(document.getElementById('successModal'));
        modal.show();
      } else {
        alert(result.error || 'Failed to add wallet.');
      }
    })
    .catch(() => {
      alert('Failed to add wallet.');
    })
    .finally(() => {
      resetButton();
    });

  function resetButton() {
    btnText.textContent = "I have made payment";
    btnLoader.classList.add("d-none");
    paymentBtn.disabled = false;
  }
}
</script>


</body>
</html>
